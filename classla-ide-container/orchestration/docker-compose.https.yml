version: "3.8"

services:
  traefik:
    image: traefik:v2.11
    command:
      # API and Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=false"

      # Docker Swarm Provider - Optimized for fast service discovery
      - "--providers.docker=true"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=ide-network"
      - "--providers.docker.watch=true"
      - "--providers.docker.swarmModeRefreshSeconds=2"  # Poll every 2 seconds for faster discovery

      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"

      # HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"

      # Let's Encrypt Certificate Resolver
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@classla.org}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"

      # Logging
      - "--log.level=INFO"
      - "--accesslog=true"

    ports:
      - "80:80"
      - "443:443"

    volumes:
      # Mount Docker socket for service discovery
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Persistent volume for certificates
      - traefik-certificates:/letsencrypt

    networks:
      - ide-network

    deploy:
      placement:
        constraints:
          # Deploy only on manager node
          - node.role == manager
      labels:
        # Enable Traefik dashboard (only on Traefik service, not management-api)
        - "traefik.enable=true"

    restart: unless-stopped

  management-api:
    image: ${REGISTRY:-local}/ide-orchestration-api:${VERSION:-latest}
    user: root
    environment:
      - NODE_ENV=production
      - PORT=3001
      - API_KEY=${API_KEY}
      - API_KEYS=${API_KEYS}
      - DOMAIN=${DOMAIN}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - DATABASE_PATH=/app/data/containers.db
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - RESOURCE_CPU_LIMIT=${RESOURCE_CPU_LIMIT:-2}
      - RESOURCE_MEMORY_LIMIT=${RESOURCE_MEMORY_LIMIT:-4294967296}
      - RESOURCE_CPU_THRESHOLD=${RESOURCE_CPU_THRESHOLD:-90}
      - RESOURCE_MEMORY_THRESHOLD=${RESOURCE_MEMORY_THRESHOLD:-90}
      - HEALTH_CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-30000}
      - HEALTH_CHECK_TIMEOUT=${HEALTH_CHECK_TIMEOUT:-5000}
      - HEALTH_CHECK_RETRIES=${HEALTH_CHECK_RETRIES:-3}
      - CONTAINER_RESTART_POLICY=${CONTAINER_RESTART_POLICY:-on-failure}
      - CONTAINER_RESTART_MAX_ATTEMPTS=${CONTAINER_RESTART_MAX_ATTEMPTS:-3}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - api-data:/app/data
    networks:
      - ide-network
    deploy:
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        # Management API - HTTPS with Let's Encrypt (via api subdomain)
        - "traefik.http.routers.management-api.rule=Host(`api.${DOMAIN}`)"
        - "traefik.http.routers.management-api.entrypoints=websecure"
        - "traefik.http.routers.management-api.tls.certresolver=letsencrypt"
        - "traefik.http.routers.management-api.service=management-api"
        - "traefik.http.services.management-api.loadbalancer.server.port=3001"
        # Management API - Also accessible via base domain with /api path
        - "traefik.http.routers.management-api-base.rule=Host(`${DOMAIN}`) && PathPrefix(`/api`)"
        - "traefik.http.routers.management-api-base.entrypoints=websecure"
        - "traefik.http.routers.management-api-base.tls.certresolver=letsencrypt"
        - "traefik.http.routers.management-api-base.service=management-api"
        - "traefik.http.routers.management-api-base.priority=5"
        # Dashboard UI - HTTPS with Let's Encrypt
        - "traefik.http.routers.dashboard.rule=Host(`dashboard.${DOMAIN}`)"
        - "traefik.http.routers.dashboard.entrypoints=websecure"
        - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
        - "traefik.http.routers.dashboard.service=dashboard"
        - "traefik.http.services.dashboard.loadbalancer.server.port=3001"

networks:
  ide-network:
    external: true

volumes:
  api-data:
    driver: local
  traefik-certificates:
    driver: local
