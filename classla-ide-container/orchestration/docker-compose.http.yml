version: "3.8"

services:
  traefik:
    image: traefik:v2.10
    command:
      # API and Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=true" # Allow insecure dashboard access for HTTP-only deployment

      # Docker Swarm Provider
      - "--providers.docker=true"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=ide-network"
      - "--providers.docker.watch=true"

      # Entrypoints - HTTP only (no HTTPS)
      - "--entrypoints.web.address=:80"

      # Logging
      - "--log.level=INFO"
      - "--accesslog=true"

    ports:
      - "80:80"
      - "8080:8080" # Dashboard port

    volumes:
      # Mount Docker socket for service discovery
      - /var/run/docker.sock:/var/run/docker.sock:ro

    networks:
      - ide-network

    deploy:
      placement:
        constraints:
          # Deploy only on manager node
          - node.role == manager
      labels:
        # Enable Traefik dashboard
        - "traefik.enable=true"
        - "traefik.http.routers.dashboard.rule=Host(`traefik.${DOMAIN:-localhost}`) || Host(`${SERVER_IP:-localhost}`)"
        - "traefik.http.routers.dashboard.entrypoints=web"
        - "traefik.http.routers.dashboard.service=api@internal"
        - "traefik.http.services.dashboard.loadbalancer.server.port=8080"

    restart: unless-stopped

  management-api:
    image: ${REGISTRY:-local}/ide-orchestration-api:${VERSION:-latest}
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/amd64  # Explicitly build for x86_64 architecture
    environment:
      - NODE_ENV=production
      - PORT=3001
      - API_KEYS=${API_KEYS}
      - DOMAIN=${DOMAIN}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - DATABASE_PATH=/app/data/containers.db
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - RESOURCE_CPU_LIMIT=${RESOURCE_CPU_LIMIT:-2}
      - RESOURCE_MEMORY_LIMIT=${RESOURCE_MEMORY_LIMIT:-4294967296}
      - RESOURCE_CPU_THRESHOLD=${RESOURCE_CPU_THRESHOLD:-90}
      - RESOURCE_MEMORY_THRESHOLD=${RESOURCE_MEMORY_THRESHOLD:-90}
      - HEALTH_CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-30000}
      - HEALTH_CHECK_TIMEOUT=${HEALTH_CHECK_TIMEOUT:-5000}
      - HEALTH_CHECK_RETRIES=${HEALTH_CHECK_RETRIES:-3}
      - CONTAINER_RESTART_POLICY=${CONTAINER_RESTART_POLICY:-on-failure}
      - CONTAINER_RESTART_MAX_ATTEMPTS=${CONTAINER_RESTART_MAX_ATTEMPTS:-3}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - api-data:/app/data
    networks:
      - ide-network
    deploy:
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        # Management API - supports both domain and IP access
        # For IP addresses, only match /api paths to avoid catching IDE container routes
        - "traefik.http.routers.management-api.rule=Host(`api.${DOMAIN}`) || (Host(`${SERVER_IP:-localhost}`) && PathPrefix(`/api`))"
        - "traefik.http.routers.management-api.entrypoints=web"
        - "traefik.http.routers.management-api.service=management-api"
        - "traefik.http.services.management-api.loadbalancer.server.port=3001"
        # Dashboard UI - supports both domain and IP access
        # For IP addresses, only match /dashboard paths
        - "traefik.http.routers.dashboard.rule=Host(`dashboard.${DOMAIN}`) || (Host(`${SERVER_IP:-localhost}`) && PathPrefix(`/dashboard`))"
        - "traefik.http.routers.dashboard.entrypoints=web"
        - "traefik.http.routers.dashboard.service=dashboard"
        - "traefik.http.services.dashboard.loadbalancer.server.port=3001"

networks:
  ide-network:
    external: true

volumes:
  api-data:
    driver: local
