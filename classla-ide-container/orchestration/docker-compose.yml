version: "3.8"

services:
  traefik:
    image: traefik:v2.11
    command:
      - "--api.dashboard=true"
      - "--api.insecure=${TRAEFIK_INSECURE:-true}"
      - "--providers.docker=true"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=ide-network"
      - "--providers.docker.watch=true"
      - "--entrypoints.web.address=:80"
      # HTTPS redirect is configured via traefik-dynamic.yml file provider
      # (only active in production when ENABLE_HTTPS=true)
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http.tls.options=default@file"
      # Note: security-headers middleware removed from entrypoint level
      # It will be applied selectively to routes that need it (management-api, dashboard)
      # Container routes use container-iframe-headers middleware instead
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--log.level=${LOG_LEVEL:-INFO}"
    ports:
      - "80:80"
      - "${DASHBOARD_PORT:-8080}:8080"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-certs:/letsencrypt
      - ./traefik-dynamic.yml:/etc/traefik/dynamic/traefik-dynamic.yml:ro
    networks:
      - ide-network
    deploy:
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        # Traefik dashboard - accessible at /traefik in production, port 8080 in local
        - "traefik.http.routers.traefik-dashboard.rule=${TRAEFIK_DASHBOARD_RULE:-Host(`localhost`)}"
        - "traefik.http.routers.traefik-dashboard.entrypoints=${TRAEFIK_DASHBOARD_ENTRYPOINT:-web}"
        - "traefik.http.routers.traefik-dashboard.tls.certresolver=${TRAEFIK_DASHBOARD_TLS:-}"
        - "traefik.http.routers.traefik-dashboard.service=api@internal"
        - "traefik.http.services.traefik-dashboard.loadbalancer.server.port=8080"
        # Strip /traefik prefix for path-based routing (production)
        - "traefik.http.middlewares.traefik-strip.stripprefix.prefixes=/traefik"
        - "traefik.http.routers.traefik-dashboard.middlewares=traefik-strip"

  management-api:
    image: ide-orchestration-api:latest
    user: root
    environment:
      - NODE_ENV=${NODE_ENV:-local}
      - PORT=3001
      - API_KEY=${API_KEY:-test-api-key-12345}
      - DOMAIN=${DOMAIN:-localhost}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-dummy-key}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-dummy-secret}
      - DATABASE_PATH=/app/data/containers.db
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - PRE_WARMED_QUEUE_SIZE=${PRE_WARMED_QUEUE_SIZE:-1}
      - INACTIVITY_TIMEOUT_SECONDS=${INACTIVITY_TIMEOUT_SECONDS:-600}
      - RESOURCE_CPU_LIMIT=${RESOURCE_CPU_LIMIT:-2}
      - RESOURCE_MEMORY_LIMIT=${RESOURCE_MEMORY_LIMIT:-4294967296}
      - RESOURCE_CPU_THRESHOLD=${RESOURCE_CPU_THRESHOLD:-90}
      - RESOURCE_MEMORY_THRESHOLD=${RESOURCE_MEMORY_THRESHOLD:-90}
      - HEALTH_CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-30000}
      - HEALTH_CHECK_TIMEOUT=${HEALTH_CHECK_TIMEOUT:-5000}
      - HEALTH_CHECK_RETRIES=${HEALTH_CHECK_RETRIES:-3}
      - CONTAINER_RESTART_POLICY=${CONTAINER_RESTART_POLICY:-on-failure}
      - CONTAINER_RESTART_MAX_ATTEMPTS=${CONTAINER_RESTART_MAX_ATTEMPTS:-3}
      - SUPABASE_URL=${SUPABASE_URL:-}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-}
      - BACKEND_API_URL=${BACKEND_API_URL:-http://localhost:8000/api}
      - CONTAINER_SERVICE_TOKEN=${CONTAINER_SERVICE_TOKEN:-}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - api-data:/app/data
    networks:
      - ide-network
    deploy:
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        # Local mode: API accessible at localhost/api
        - "traefik.http.routers.ide-api.rule=Host(`localhost`) && PathPrefix(`/api`)"
        - "traefik.http.routers.ide-api.entrypoints=web"
        - "traefik.http.routers.ide-api.service=ide-api"
        - "traefik.http.services.ide-api.loadbalancer.server.port=3001"
        - "traefik.http.middlewares.ide-api-stripprefix.stripprefix.prefixes=/api"
        - "traefik.http.routers.ide-api.middlewares=ide-api-stripprefix"
        # Local mode: Dashboard accessible at localhost/dashboard
        - "traefik.http.routers.ide-dashboard.rule=Host(`localhost`) && PathPrefix(`/dashboard`)"
        - "traefik.http.routers.ide-dashboard.entrypoints=web"
        - "traefik.http.routers.ide-dashboard.service=ide-api"
        - "traefik.http.middlewares.ide-dashboard-stripprefix.stripprefix.prefixes=/dashboard"
        - "traefik.http.routers.ide-dashboard.middlewares=ide-dashboard-stripprefix"
        # Production mode: Path-based routes under main domain
        # These use environment variables set by start.sh in production mode
        # API route at /api (strips prefix before forwarding)
        - "traefik.http.routers.management-api-main.rule=${MANAGEMENT_API_MAIN_RULE:-Host(`invalid.localhost`) && PathPrefix(`/api`)}"
        - "traefik.http.routers.management-api-main.entrypoints=${MANAGEMENT_API_MAIN_ENTRYPOINT:-web}"
        - "traefik.http.routers.management-api-main.tls.certresolver=${MANAGEMENT_API_MAIN_TLS:-}"
        - "traefik.http.routers.management-api-main.service=management-api"
        - "traefik.http.middlewares.management-api-main-strip.stripprefix.prefixes=/api"
        - "traefik.http.routers.management-api-main.middlewares=management-api-main-strip,security-headers@file"
        - "traefik.http.services.management-api.loadbalancer.server.port=3001"
        # Dashboard route at /dashboard (strips prefix before forwarding)
        - "traefik.http.routers.dashboard.rule=${DASHBOARD_RULE:-Host(`invalid.localhost`) && PathPrefix(`/dashboard`)}"
        - "traefik.http.routers.dashboard.entrypoints=${DASHBOARD_ENTRYPOINT:-web}"
        - "traefik.http.routers.dashboard.tls.certresolver=${DASHBOARD_TLS:-}"
        - "traefik.http.routers.dashboard.service=management-api"
        - "traefik.http.middlewares.dashboard-strip.stripprefix.prefixes=/dashboard"
        - "traefik.http.routers.dashboard.middlewares=dashboard-strip,security-headers@file"

networks:
  ide-network:
    external: true

volumes:
  traefik-certs:
    driver: local
  api-data:
    driver: local
